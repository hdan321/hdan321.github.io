<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>德州筹码记录卡 v2.1｜本地运行</title>
  <style>
    :root{--bg:#0b0f14;--card:#121822;--muted:#8aa0b2;--text:#e9f0f6;--accent:#4cc9f0;--ok:#22c55e;--bad:#ef4444;--border:#1f2937}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans SC","PingFang SC","Hiragino Sans GB",sans-serif}
    .container{max-width:1100px;margin:0 auto;padding:16px 16px 120px}
    h1{font-size:28px;margin:12px 0 8px}
    .sub{color:var(--muted);font-size:14px;margin-bottom:14px}
    .grid{display:grid;gap:12px}
    @media(min-width:900px){.grid-2{grid-template-columns:1.1fr .9fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .card h2{font-size:18px;margin:0 0 10px}
    label{font-size:13px;color:var(--muted)}
    input,select,button,textarea{font:inherit}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row-3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .row-4{display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px}
    .stack{display:flex;gap:8px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .pill{padding:6px 10px;border:1px solid var(--border);border-radius:999px;background:#0e141d}
    .btn{border:none;border-radius:10px;padding:10px 12px;background:#162133;color:var(--text);cursor:pointer}
    .btn:hover{background:#1a2740}
    .btn.acc{background:linear-gradient(90deg,#1e90ff,#4cc9f0)}
    .btn.acc:hover{filter:brightness(1.08)}
    .btn.warn{background:#2a1a1f}
    .btn.ok{background:#12281a}
    .btn.danger{background:#2b1616}
    input[type="number"],input[type="text"]{width:100%;padding:10px 10px;border-radius:10px;border:1px solid var(--border);background:#0e141d;color:var(--text)}
    table{width:100%;border-collapse:collapse;overflow:hidden;border-radius:12px;border:1px solid var(--border)}
    th,td{padding:10px;border-bottom:1px solid var(--border);text-align:right}
    th:first-child,td:first-child{text-align:left}
    thead th{position:sticky;top:0;background:#0e141d;z-index:1}
    tbody tr:hover{background:#0f1725}
    .pos{color:var(--ok);font-weight:600}
    .neg{color:var(--bad);font-weight:600}
    .footerbar{position:fixed;left:0;right:0;bottom:0;background:rgba(10,14,20,.9);backdrop-filter:blur(8px);border-top:1px solid var(--border)}
    .footerbar .inner{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .grow{flex:1}
    .badge{font-size:12px;color:var(--muted)}
    .small{font-size:12px}
    .scroll{max-height:260px;overflow:auto;border-radius:12px;border:1px solid var(--border)}
    .hr{height:1px;background:var(--border);margin:10px 0}
    .link{color:var(--accent);text-decoration:none}
    .table-actions button{padding:6px 8px;font-size:12px}
  </style>
</head>
<body>
  <div class="container">
    <h1>德州筹码记录卡 v2.1</h1>
    <div class="sub">离线、本地保存。此版把「盈亏(金额)」改为**净现金流(金额)**：买入记负、退筹记正，因此开局每人会显示 -买入金额（例如 20000=100 元，则为 -100 元）。</div>

    <div class="grid grid-2">
      <section class="card">
        <h2>① 游戏设置</h2>
        <div class="row-3">
          <div>
            <label>每位初始积分</label>
            <input id="initialPoints" type="number" inputmode="numeric" value="20000" min="0" />
          </div>
          <div>
            <label>换算：积分 =</label>
            <input id="pointsBase" type="number" inputmode="numeric" value="20000" min="1" />
          </div>
          <div>
            <label>等于 货币（单位额）</label>
            <input id="currencyBase" type="number" inputmode="decimal" value="200" min="0" step="0.01" />
          </div>
        </div>
        <div class="row">
          <div>
            <label>货币单位（显示）</label>
            <input id="currencyLabel" type="text" value="人民币" />
          </div>
          <div class="pill" style="display:flex;align-items:center;gap:8px">
            <span class="muted">当前汇率：</span>
            <span id="rateText">1 积分 = 0.01 人民币</span>
          </div>
        </div>
        <div class="stack" style="margin-top:10px">
          <button class="btn ok" id="saveSettings">保存设置</button>
          <button class="btn warn" id="newGame">新一局（清空数据）</button>
          <span class="badge">自动保存在本机（localStorage）</span>
        </div>
      </section>

      <section class="card">
        <h2>② 玩家</h2>
        <div class="row">
          <input id="playerName" placeholder="玩家昵称，如：老王" />
          <button class="btn acc" id="addPlayer">添加玩家</button>
        </div>
        <div class="hr"></div>
        <div class="scroll">
          <table>
            <thead>
              <tr>
                <th>玩家</th>
                <th>初始积分</th>
                <th>已补积分(可负)</th>
                <th>当前持有(积分)</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody id="playersTbody"></tbody>
          </table>
        </div>
      </section>
    </div>

    <section class="card">
      <h2>③ 记录补筹码 / 结算</h2>
      <div class="row-4">
        <select id="topupPlayer"></select>
        <input id="topupAmount" type="number" inputmode="numeric" placeholder="补筹码积分，例如 5000；填负数表示退筹（兑现）" />
        <input id="topupNote" placeholder="备注（可选）" />
        <button class="btn" id="addTopup">添加补筹记录</button>
      </div>
      <div class="small muted" style="margin-top:6px">贴士：输光需要买入时，填正数；有人中途兑现退筹时，填负数（系统自动换算现金流）。</div>
      <div class="hr"></div>

      <div class="row">
        <div>
          <label>“当前持有(积分)”可随时填写，用于实时查看筹码盈亏；右侧“净现金流(金额)”仅统计现金进出。</label>
        </div>
        <div style="text-align:right">
          <button class="btn" id="fillEven">一键均分剩余（测试用）</button>
        </div>
      </div>
      <div class="scroll" style="margin-top:8px">
        <table>
          <thead>
            <tr>
              <th>玩家</th>
              <th>总买入(积分)</th>
              <th>当前持有(积分)</th>
              <th>盈亏(积分)</th>
              <th>净现金流(金额)</th>
              <th>明细</th>
            </tr>
          </thead>
          <tbody id="settleTbody"></tbody>
        </table>
      </div>
      <div class="stack" style="margin-top:10px">
        <button class="btn acc" id="compute">计算结算</button>
        <button class="btn" id="exportCsv">导出CSV</button>
        <button class="btn" id="exportJson">导出JSON</button>
        <button class="btn danger" id="clearAll">清空所有数据</button>
        <div class="grow"></div>
        <div class="pill">总盈亏校验：<span id="sumCheck">0</span> 积分（应=0）</div>
      </div>
    </section>

    <section class="card">
      <h2>④ 现金流水（按时间）</h2>
      <div class="scroll">
        <table>
          <thead>
            <tr>
              <th>时间</th>
              <th>玩家</th>
              <th>积分变化</th>
              <th>备注</th>
              <th>金额变化</th>
              <th>操作</th>
            </tr>
          </thead>
          <tbody id="ledgerTbody"></tbody>
        </table>
      </div>
      <div class="small muted" style="margin-top:6px">规则：买入为正积分，对应现金记负；退筹为负积分，对应现金记正。例：20000积分=100元，则开局每人“净现金流”列显示 -100 元。</div>
    </section>

    <section class="card">
      <h2>使用说明</h2>
      <ol class="small">
        <li>设置初始积分与“积分↔金额”的换算比例（例如：20000 积分 = 100 人民币）。</li>
        <li>添加玩家：会自动生成“初始买入”流水；结算区“净现金流(金额)”会显示 -买入金额。</li>
        <li>补筹填正数、退筹填负数。“净现金流(金额)”只看现金；“盈亏(积分)”看筹码变化。</li>
        <li>结算时，在“当前持有(积分)”填入最终筹码即可；导出 CSV/JSON 备份。</li>
      </ol>
    </section>
  </div>

  <div class="footerbar">
    <div class="inner">
      <div class="pill">快捷键：<span class="small">Ctrl/Cmd+S 保存设置 · Ctrl/Cmd+Enter 添加补筹 · Ctrl/Cmd+K 计算结算</span></div>
      <div class="grow"></div>
      <a class="link small" href="#" id="downloadLink" style="display:none">下载文件</a>
    </div>
  </div>

<script>
(function(){
  const $ = (id)=>document.getElementById(id)

  const state = {
    settings: {
      initialPoints: 20000,
      pointsBase: 20000,
      currencyBase: 100,
      currencyLabel: '人民币'
    },
    players: [] // {id, name, initialPoints, created, topups:[{id, pts, note, ts}], finalPoints}
  }

  const uid = ()=> Math.random().toString(36).slice(2,10)

  function load(){
    try{
      const raw = localStorage.getItem('poker-chip-tracker-v21')
      if(raw){ Object.assign(state, JSON.parse(raw)) }
    }catch(e){ console.warn(e) }
  }
  function save(){
    localStorage.setItem('poker-chip-tracker-v21', JSON.stringify(state))
  }

  function rate(){
    const {pointsBase, currencyBase} = state.settings
    if(pointsBase<=0) return 0
    return currencyBase / pointsBase // currency per point
  }
  function fmtMoney(x){
    return (Math.round((x + Number.EPSILON)*100)/100).toFixed(2)
  }
  function updateRateText(){
    const r = rate()
    $('rateText').textContent = `1 积分 = ${fmtMoney(r)} ${state.settings.currencyLabel}`
  }

  function renderPlayers(){
    const tbody = $('playersTbody')
    tbody.innerHTML = ''
    state.players.forEach(p=>{
      const tr = document.createElement('tr')
      const topupSum = p.topups.reduce((a,b)=>a+b.pts,0)
      tr.innerHTML = `
        <td style="text-align:left">${escapeHtml(p.name)}</td>
        <td>${p.initialPoints}</td>
        <td>${topupSum}</td>
        <td>${(p.finalPoints ?? '')}</td>
        <td class="table-actions" style="text-align:right">
          <button class="btn small" data-act="edit-name" data-id="${p.id}">改名</button>
          <button class="btn small" data-act="set-final" data-id="${p.id}">填持有</button>
          <button class="btn small" data-act="del-player" data-id="${p.id}">删除</button>
        </td>`
      tbody.appendChild(tr)
    })
    const sel = $('topupPlayer')
    sel.innerHTML = ''
    state.players.forEach(p=>{
      const opt = document.createElement('option')
      opt.value = p.id
      opt.textContent = p.name
      sel.appendChild(opt)
    })
    renderLedger()
    renderSettlement()
  }

  function renderLedger(){
    const all = []
    state.players.forEach(p=>{
      all.push({p, t:{id:'init-'+p.id, pts:p.initialPoints, note:'初始买入', ts:p.created||0, isInit:true}})
      p.topups.forEach(t=> all.push({p, t}))
    })
    all.sort((a,b)=>a.t.ts-b.t.ts)
    const tbody = $('ledgerTbody')
    tbody.innerHTML = ''
    all.forEach(({p,t})=>{
      const tr = document.createElement('tr')
      const d = new Date(t.ts)
      const money = - t.pts * rate() // 正积分=买入=现金流出（负）；负积分=退筹=现金流入（正）
      tr.innerHTML = `
        <td style="text-align:left">${d.toLocaleString()}</td>
        <td style="text-align:left">${escapeHtml(p.name)}</td>
        <td>${t.pts}</td>
        <td style="text-align:left">${escapeHtml(t.note|| (t.isInit?'初始买入':''))}</td>
        <td class="${money>=0?'pos':'neg'}">${money>=0?'+':''}${fmtMoney(money)} ${state.settings.currencyLabel}</td>
        <td class="table-actions" style="text-align:right">${t.isInit? '' : `<button class=\"btn small\" data-act=\"del-topup\" data-id=\"${p.id}\" data-tid=\"${t.id}\">删除</button>`}</td>`
      tbody.appendChild(tr)
    })
  }

  function renderSettlement(){
    const tbody = $('settleTbody')
    tbody.innerHTML = ''
    let sumDelta = 0
    state.players.forEach(p=>{
      const buyin = p.initialPoints + p.topups.reduce((a,b)=>a+b.pts,0) // 允许负数退筹
      const final = Number(p.finalPoints||0)
      const delta = final - buyin
      sumDelta += delta
      const money = - buyin * rate() // **改为净现金流：买入记负、退筹记正**
      const tr = document.createElement('tr')
      tr.innerHTML = `
        <td style=\"text-align:left\">${escapeHtml(p.name)}</td>
        <td>${buyin}</td>
        <td>
          <input data-act=\"final-input\" data-id=\"${p.id}\" type=\"number\" inputmode=\"numeric\" value=\"${p.finalPoints??''}\" style=\"width:120px\"/>
        </td>
        <td class=\"${delta>=0?'pos':'neg'}\">${delta}</td>
        <td class=\"${money>=0?'pos':'neg'}\">${fmtMoney(money)} ${state.settings.currencyLabel}</td>
        <td style=\"text-align:left\">初始:${p.initialPoints}${p.topups.length? '，补筹:'+ p.topups.map(t=>t.pts).join('+') : ''}</td>`
      tbody.appendChild(tr)
    })
    $('sumCheck').textContent = sumDelta
  }

  function addPlayer(name){
    if(!name) return
    const now = Date.now()
    const p = {id: uid(), name: name.trim(), initialPoints: state.settings.initialPoints, created: now, topups: [], finalPoints: state.settings.initialPoints}
    state.players.push(p)
    save(); renderPlayers()
  }

  function addTopup(pid, amount, note){
    const p = state.players.find(x=>x.id===pid)
    if(!p) return
    const pts = Number(amount||0)
    if(!Number.isFinite(pts) || pts===0) return
    p.topups.push({id: uid(), pts, note: (note||'').trim(), ts: Date.now()})
    save(); renderPlayers()
  }

  function exportCSV(){
    const rows = []
    rows.push(['玩家','初始积分','补筹合计(可负)','总买入(积分)','当前持有(积分)','盈亏(积分)','净现金流('+state.settings.currencyLabel+')'])
    state.players.forEach(p=>{
      const topup = p.topups.reduce((a,b)=>a+b.pts,0)
      const buyin = p.initialPoints + topup
      const final = Number(p.finalPoints||0)
      const delta = final - buyin
      const money = fmtMoney(-buyin*rate())
      rows.push([p.name,p.initialPoints,topup,buyin,final,delta,money])
    })
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n')
    downloadFile('结算.csv', new Blob(["\ufeff"+csv],{type:'text/csv;charset=utf-8;'}))
  }
  function exportJSON(){
    const data = JSON.stringify(state, null, 2)
    downloadFile('poker_chip_tracker_v21_backup.json', new Blob([data],{type:'application/json'}))
  }
  function downloadFile(filename, blob){
    const link = $('downloadLink')
    link.href = URL.createObjectURL(blob)
    link.download = filename
    link.style.display = 'inline'
    link.textContent = '点击下载：'+filename
    link.click()
    setTimeout(()=>{URL.revokeObjectURL(link.href); link.style.display='none'}, 1500)
  }

  function escapeHtml(str){
    return String(str).replace(/[&<>"']/g, s=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]))
  }

  // UI events
  $('saveSettings').addEventListener('click', ()=>{
    state.settings.initialPoints = Math.max(0, Number($('initialPoints').value||0))
    state.settings.pointsBase = Math.max(1, Number($('pointsBase').value||1))
    state.settings.currencyBase = Math.max(0, Number($('currencyBase').value||0))
    state.settings.currencyLabel = $('currencyLabel').value.trim()||'货币'
    updateRateText(); save(); renderSettlement(); renderLedger()
  })
  $('newGame').addEventListener('click', ()=>{
    if(!confirm('开始新一局？这将清空所有玩家与记录。')) return
    state.players = []
    save(); renderPlayers(); renderSettlement(); renderLedger()
  })
  $('addPlayer').addEventListener('click', ()=>{
    addPlayer($('playerName').value)
    $('playerName').value = ''
  })
  $('playerName').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ $('addPlayer').click() }})

  $('addTopup').addEventListener('click', ()=>{
    const pid = $('topupPlayer').value
    const amt = $('topupAmount').value
    addTopup(pid, amt, $('topupNote').value)
    $('topupAmount').value = ''
    $('topupNote').value = ''
  })
  $('topupAmount').addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ $('addTopup').click() }})

  $('playersTbody').addEventListener('click', (e)=>{
    const b = e.target.closest('button')
    if(!b) return
    const id = b.getAttribute('data-id')
    const act = b.getAttribute('data-act')
    const p = state.players.find(x=>x.id===id)
    if(!p) return
    if(act==='del-player'){
      if(confirm(`删除玩家【${p.name}】？`)){
        state.players = state.players.filter(x=>x.id!==id)
        save(); renderPlayers(); renderLedger(); renderSettlement()
      }
    }else if(act==='edit-name'){
      const nv = prompt('输入新昵称：', p.name)
      if(nv){ p.name = nv.trim(); save(); renderPlayers(); renderLedger(); renderSettlement() }
    }else if(act==='set-final'){
      const fv = prompt('填入该玩家的“当前持有积分”', p.finalPoints??0)
      if(fv!==null){ p.finalPoints = Number(fv)||0; save(); renderSettlement(); renderPlayers() }
    }
  })

  $('ledgerTbody').addEventListener('click', (e)=>{
    const b = e.target.closest('button')
    if(!b) return
    const act = b.getAttribute('data-act')
    if(act==='del-topup'){
      const pid = b.getAttribute('data-id')
      const tid = b.getAttribute('data-tid')
      const p = state.players.find(x=>x.id===pid)
      if(!p) return
      p.topups = p.topups.filter(t=>t.id!==tid)
      save(); renderPlayers(); renderLedger(); renderSettlement()
    }
  })

  $('settleTbody').addEventListener('input', (e)=>{
    const inp = e.target.closest('input[data-act="final-input"]')
    if(!inp) return
    const id = inp.getAttribute('data-id')
    const p = state.players.find(x=>x.id===id)
    if(!p) return
    p.finalPoints = Number(inp.value)||0
    save(); renderSettlement()
  })

  $('compute').addEventListener('click', ()=>{
    renderSettlement()
    const sum = Number($('sumCheck').textContent||0)
    if(sum!==0){
      alert('提示：总盈亏不为0，请复核“当前持有”或补筹/退筹记录。')
    }else{
      alert('已计算完成！可导出CSV/JSON留档。')
    }
  })

  $('fillEven').addEventListener('click', ()=>{
    if(state.players.length===0) return
    const totalBuyin = state.players.reduce((s,p)=> s + p.initialPoints + p.topups.reduce((a,b)=>a+b.pts,0), 0)
    const avg = Math.floor(totalBuyin / state.players.length)
    state.players.forEach(p=> p.finalPoints = avg)
    save(); renderSettlement()
  })

  $('exportCsv').addEventListener('click', exportCSV)
  $('exportJson').addEventListener('click', exportJSON)
  $('clearAll').addEventListener('click', ()=>{
    if(confirm('确定彻底清除本地保存的所有数据？')){
      localStorage.removeItem('poker-chip-tracker-v21')
      location.reload()
    }
  })

  // keyboard shortcuts
  document.addEventListener('keydown', (e)=>{
    const cmd = (e.ctrlKey||e.metaKey)
    if(cmd && e.key.toLowerCase()==='s'){ e.preventDefault(); $('saveSettings').click() }
    if(cmd && e.key==='Enter'){ e.preventDefault(); $('addTopup').click() }
    if(cmd && e.key.toLowerCase()==='k'){ e.preventDefault(); $('compute').click() }
  })

  // init
  load()
  $('initialPoints').value = state.settings.initialPoints
  $('pointsBase').value = state.settings.pointsBase
  $('currencyBase').value = state.settings.currencyBase
  $('currencyLabel').value = state.settings.currencyLabel
  updateRateText()
  renderPlayers()

})();
</script>
</body>
</html>
